# Security Implementation Guide

This guide provides quick instructions for developers and DevOps teams to understand and deploy the security fixes.

## Quick Start

### For Development

1. **Set up environment variables:**
   ```bash
   cp .env.example .env
   # Edit .env and set at least:
   # - SECRET_KEY (minimum 32 characters)
   ```

2. **Generate a secure SECRET_KEY:**
   ```bash
   python -c 'import secrets; print(secrets.token_urlsafe(64))'
   ```

3. **Run the application:**
   ```bash
   # With Docker
   docker-compose up -d
   
   # Or locally
   pip install -r requirements.txt
   python src/main.py
   ```

### For Production

1. **Use the secret generation script:**
   ```bash
   chmod +x scripts/generate-secrets.sh
   ./scripts/generate-secrets.sh
   ```

2. **Review and customize `.env` file** generated by the script

3. **Set up HTTPS certificate** (recommended: Let's Encrypt)

4. **Deploy with Docker:**
   ```bash
   docker-compose up -d
   ```

5. **Verify security:**
   ```bash
   # Check HTTPS redirect
   curl -I http://yourdomain.com
   
   # Check security headers
   curl -I https://yourdomain.com
   ```

## What Changed?

### Critical Security Fixes

1. **Strong Password Requirements**
   - Minimum 12 characters
   - Must include: uppercase, lowercase, numbers, special characters
   - Blocks common passwords against a comprehensive list (150+ passwords)
   - Checks against known weak passwords from security research
   - Updatable password blocklist (see `src/auth/data/README.md`)

2. **Mandatory SECRET_KEY Configuration**
   - No default fallback (application will fail if not set)
   - Minimum 32 characters required
   - Must be unique per environment

### High Priority Fixes

3. **HTTPS Enforcement** (Production only)
   - Automatic redirect from HTTP to HTTPS
   - Security headers on all responses
   - HSTS enabled for 1 year

4. **Restricted CORS**
   - Development: localhost only
   - Production: explicit whitelist required
   - No wildcard methods/headers

5. **Secure Database Configuration**
   - No hardcoded credentials
   - PostgreSQL not exposed to host
   - Access only via Docker internal network

### Medium Priority Fixes

6. **Rate Limiting**
   - Login: 5 attempts/minute
   - Registration: 3/hour
   - Token refresh: 10/minute

7. **Input Validation**
   - HTML escaping (XSS prevention)
   - Length limits enforced
   - Dangerous characters filtered

## Environment Variables

### Required

```bash
# Application Security (REQUIRED)
SECRET_KEY=your-generated-secret-key-here  # Min 32 chars
ENVIRONMENT=production                      # production/staging/development

# Database (REQUIRED for Docker deployment)
POSTGRES_PASSWORD=your-database-password    # Min 32 chars recommended
```

### Optional

```bash
# CORS Configuration
CORS_ORIGINS=https://yourdomain.com,https://www.yourdomain.com

# Database Configuration
POSTGRES_DB=clockit
POSTGRES_USER=clockit
POSTGRES_HOST=clockit-db
POSTGRES_PORT=5432

# JWT Configuration
JWT_ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=15
REFRESH_TOKEN_EXPIRE_DAYS=7

# Logging
LOG_LEVEL=INFO
LOG_FORMAT=json
```

## Security Headers Added

All API responses now include:

- `Strict-Transport-Security`: Forces HTTPS (production only)
- `Content-Security-Policy`: Prevents XSS and injection
- `X-Content-Type-Options: nosniff`: Prevents MIME sniffing
- `X-Frame-Options: DENY`: Prevents clickjacking
- `X-XSS-Protection: 1; mode=block`: Browser XSS protection
- `Referrer-Policy: strict-origin-when-cross-origin`: Controls referrer
- `Permissions-Policy`: Restricts browser features

## Password Requirements

Users must now create passwords that:
- Are at least 12 characters long
- Contain at least one uppercase letter (A-Z)
- Contain at least one lowercase letter (a-z)
- Contain at least one number (0-9)
- Contain at least one special character (!@#$%^&*...)
- Don't contain obvious patterns (1234, aaaa, etc.)
- Aren't in the common password list (150+ known weak passwords)

**Example valid password:** `MySecure!Pass9876`

### Maintaining the Password Blocklist

The application checks passwords against a curated list of weak/common passwords.

**Update the list:**
```bash
./scripts/update-password-list.sh
```

**Manual editing:**
Edit `src/auth/data/common_passwords.txt` and restart the application.

See `src/auth/data/README.md` for detailed maintenance instructions.

## Rate Limiting

The following endpoints have rate limits:

| Endpoint | Limit | Purpose |
|----------|-------|---------|
| `/auth/login` | 5/minute | Prevent brute force |
| `/auth/register` | 3/hour | Prevent spam accounts |
| `/auth/refresh` | 10/minute | Reasonable refresh rate |

When rate limit is exceeded, you'll receive HTTP 429 (Too Many Requests).

## Testing

### Run Tests

```bash
# Set test environment
export ENVIRONMENT=test
export DEV_MODE=sqlite
export SECRET_KEY="test-secret-key-for-ci-testing-at-least-32-characters-long"

# Run all tests
pytest tests/

# Run specific test suite
pytest tests/test_auth.py -v
```

### Security Testing

```bash
# Check for vulnerabilities (if CodeQL is set up)
codeql database analyze --format=sarif-latest

# Manual security checks
curl -I https://yourdomain.com | grep -E "X-Frame|X-Content|Strict-Transport"
```

## Troubleshooting

### Application Won't Start

**Error:** "SECRET_KEY environment variable must be set"

**Solution:** Set a SECRET_KEY in your `.env` file:
```bash
SECRET_KEY=$(python -c 'import secrets; print(secrets.token_urlsafe(64))')
```

### Password Rejected During Registration

**Error:** "Password must be at least 12 characters long" or similar

**Solution:** Ensure your password meets all requirements:
- At least 12 characters
- Uppercase, lowercase, numbers, special characters
- No common patterns

### Rate Limit Exceeded

**Error:** HTTP 429 "Too Many Requests"

**Solution:** Wait a few minutes before trying again. Rate limits are:
- Login: 5 attempts per minute
- Registration: 3 per hour

### CORS Error in Browser

**Error:** "Access-Control-Allow-Origin" blocked

**Solution for Development:**
- Ensure you're accessing from localhost:5173 or localhost:3000
- Check that ENVIRONMENT is set to "development"

**Solution for Production:**
- Add your domain to CORS_ORIGINS environment variable
- Example: `CORS_ORIGINS=https://app.example.com,https://www.example.com`

### Database Connection Failed

**Error:** "Database connection failed"

**Solution:**
- Check POSTGRES_PASSWORD is set in your `.env` file
- Verify docker-compose is running: `docker-compose ps`
- Check database container logs: `docker-compose logs clockit-db`

## Migration from Previous Version

If you're upgrading from a version before these security fixes:

1. **Backup your data** (very important!)

2. **Update environment variables:**
   ```bash
   # Add to your .env file
   SECRET_KEY=<generate-secure-key>
   ```

3. **Existing users will need to reset passwords** if they don't meet new requirements
   - They'll get an error message on login
   - Implement password reset functionality (see SECURITY_FIXES_SUMMARY.md for recommendations)

4. **Update CORS configuration** if deploying to production:
   ```bash
   CORS_ORIGINS=https://yourdomain.com
   ```

5. **Deploy the update:**
   ```bash
   docker-compose down
   docker-compose up -d --build
   ```

## Security Best Practices

1. **Never commit secrets:**
   - `.env` files are gitignored
   - Use environment-specific secrets
   - Rotate secrets regularly

2. **Use HTTPS in production:**
   - Get a free certificate from Let's Encrypt
   - Configure your reverse proxy/load balancer

3. **Monitor your logs:**
   - Watch for failed login attempts
   - Set up alerts for unusual activity

4. **Keep dependencies updated:**
   - Run `pip list --outdated` regularly
   - Test updates in staging first

5. **Regular security audits:**
   - Review access logs weekly
   - Run security scans monthly
   - Full audit quarterly

## Support

For security issues:
- **Critical vulnerabilities:** Report privately to security team
- **Questions:** Check SECURITY_FIXES_SUMMARY.md
- **General issues:** Open a GitHub issue

## Additional Resources

- [SECURITY_FIXES_SUMMARY.md](SECURITY_FIXES_SUMMARY.md) - Detailed implementation summary
- [SECURITY_AUDIT_REPORT.md](SECURITY_AUDIT_REPORT.md) - Original audit findings
- [SECURITY_RECOMMENDATIONS.md](SECURITY_RECOMMENDATIONS.md) - Implementation guide
- [.env.example](.env.example) - Environment variable template

---

**Last Updated:** October 20, 2025  
**Version:** 1.0  
**Status:** Production Ready
