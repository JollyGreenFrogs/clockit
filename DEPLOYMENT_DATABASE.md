# ClockIt Deployment Guide

This guide covers deploying ClockIt with proper PostgreSQL database setup from scratch.

## Prerequisites

- Ubuntu/Debian server with Docker and Docker Compose
- SSH access configured 
- Port 80 and 443 available (for Cloudflare tunnel)

## Deployment Process

### 1. Automatic Deployment

The deployment handles complete database setup automatically:

```bash
# Deploy to EC2 server
./deploy.sh
```

This script:
1. Copies deployment script to server
2. Runs complete setup on remote server
3. Tests deployment health

### 2. What Happens During Deployment

#### Server Setup
- Installs Docker and Docker Compose
- Clones repository 
- Generates secure credentials

#### Database Setup  
- Starts PostgreSQL container
- **Automatically initializes database** via `scripts/init_database.py`:
  - Creates all tables (users, categories, tasks, time_entries, etc.)
  - Runs schema migrations (including category structure updates)
  - Seeds default data (currencies)
  - Performs health checks

#### Application Startup
- Builds frontend and backend containers
- Starts all services with proper dependencies
- Verifies database initialization completed successfully

### 3. Database Architecture

**Proper Category â†’ Task â†’ TimeEntry Hierarchy:**

```
Category (contains rates, colors, metadata)
â”œâ”€â”€ day_rate: 400.00
â”œâ”€â”€ hourly_rate: 50.00 (calculated)
â”œâ”€â”€ color: "#007bff"
â””â”€â”€ is_default: true

Task (references category by ID)
â”œâ”€â”€ category_id: â†’ Category.id
â”œâ”€â”€ hourly_rate_override: null (inherit from category)
â””â”€â”€ name: "Website Development"

TimeEntry (references task)
â”œâ”€â”€ task_id: â†’ Task.id
â”œâ”€â”€ duration: 7200000 (2 hours in ms)
â””â”€â”€ description: "Fixed responsive layout"
```

### 4. Environment Configuration

**Development (.env):**
```bash
DATABASE_TYPE=postgres
POSTGRES_HOST=localhost
POSTGRES_PORT=5432  
POSTGRES_DB=clockit
POSTGRES_USER=clockit
POSTGRES_PASSWORD=clockit_dev_pass
```

**Production (auto-generated):**
```bash
DATABASE_TYPE=postgres
POSTGRES_HOST=clockit-db  # Docker internal network
POSTGRES_PORT=5432
POSTGRES_DB=clockit
POSTGRES_USER=clockit
POSTGRES_PASSWORD=<auto-generated-secure-password>
```

### 5. Database Initialization Script

`scripts/init_database.py` handles:

1. **Wait for Database**: Retries connection until PostgreSQL is ready
2. **Create Tables**: Creates all required tables using SQLAlchemy models
3. **Run Migrations**: Applies schema updates (e.g., category structure migration)
4. **Seed Data**: Populates default currencies and essential data
5. **Health Check**: Verifies all tables exist and are accessible

### 6. Monitoring Deployment

#### Check Deployment Status
```bash
ssh docker_srv 'cd /opt/clockit && docker-compose ps'
```

#### View Initialization Logs
```bash
ssh docker_srv 'cd /opt/clockit && docker-compose logs clockit-backend'
```

#### Manual Database Access
```bash
ssh docker_srv 'cd /opt/clockit && docker exec -it clockit-db psql -U clockit'
```

### 7. Troubleshooting

#### Database Connection Issues
```bash
# Check PostgreSQL container
docker-compose logs clockit-db

# Check backend initialization
docker-compose logs clockit-backend | grep -A 10 -B 10 "database"
```

#### Failed Initialization
```bash
# Restart with fresh database
docker-compose down -v  # WARNING: Destroys data
docker-compose up -d
```

#### Manual Database Reset
```bash
# Connect to PostgreSQL and reset
docker exec -it clockit-db psql -U clockit
\c clockit
DROP SCHEMA public CASCADE;
CREATE SCHEMA public;
\q

# Restart backend to re-initialize
docker-compose restart clockit-backend
```

### 8. Development vs Production

**Both environments use PostgreSQL** to ensure consistency:

- **Development**: Local PostgreSQL instance
- **Production**: Containerized PostgreSQL with data persistence

**No SQLite in production** - consistent database engine across all environments.

### 9. Backup and Recovery

#### Automated Backup (included in deployment)
```bash
# Backup is created automatically during deployment
# Location: ~/clockit-backup-YYYYMMDD-HHMMSS.sql
```

#### Manual Backup
```bash
docker exec clockit-db pg_dump -U clockit clockit > backup.sql
```

#### Restore
```bash
docker exec -i clockit-db psql -U clockit < backup.sql
```

### 10. Post-Deployment Verification

After deployment completes:

1. **Health Check**: `curl http://server-ip/health`
2. **API Docs**: Visit `http://server-ip/docs`
3. **Frontend**: Visit `http://server-ip`
4. **Database**: Verify tables exist and contain default data

The deployment is successful when:
- âœ… All containers are running
- âœ… Database initialization completed without errors  
- âœ… Health checks pass
- âœ… Frontend loads correctly
- âœ… Backend API responds

## Summary

This deployment setup ensures:
- **Consistent PostgreSQL** across dev/prod
- **Automatic database initialization** from scratch
- **Proper schema migrations** 
- **Default data seeding**
- **Health monitoring** throughout deployment
- **Zero-downtime** database setup

No manual database setup required - everything is automated! ðŸš€